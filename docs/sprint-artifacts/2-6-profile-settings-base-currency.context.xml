<story-context id="2-6-profile-settings-base-currency" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>6</storyId>
    <title>Profile Settings &amp; Base Currency</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-6-profile-settings-base-currency.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>update my profile and set my base currency</iWant>
    <soThat>all portfolio values display in my preferred currency</soThat>
    <tasks>
      <task id="1" status="pending">
        <title>Create User Profile API Route</title>
        <file>src/app/api/user/profile/route.ts</file>
        <details>GET handler for current user profile, PATCH handler with Zod validation for name (max 100 chars) and baseCurrency (8 currency enum)</details>
      </task>
      <task id="2" status="pending">
        <title>Create User Service Function</title>
        <file>src/lib/services/user-service.ts</file>
        <details>Create updateUserProfile(userId, data) function with Drizzle update and cache invalidation</details>
      </task>
      <task id="3" status="pending">
        <title>Create Settings Page</title>
        <file>src/app/(dashboard)/settings/page.tsx</file>
        <details>Replace placeholder with server component that fetches user and renders ProfileSettingsForm</details>
      </task>
      <task id="4" status="pending">
        <title>Create Profile Settings Form Component</title>
        <file>src/components/settings/profile-settings-form.tsx</file>
        <details>Client component with React Hook Form, Zod validation, name input, currency select, auto-save with debounce, success indicator</details>
      </task>
      <task id="5" status="pending">
        <title>Add Sidebar Link to Settings</title>
        <file>src/components/dashboard/app-sidebar.tsx</file>
        <details>Settings menu item already exists in navItems array at line 48 - verify active state works correctly</details>
      </task>
      <task id="6" status="pending">
        <title>Create Unit Tests</title>
        <file>tests/unit/services/user-service.test.ts</file>
        <details>Test updateUserProfile: name updates, currency updates, validation, cache invalidation</details>
      </task>
      <task id="7" status="pending">
        <title>Create E2E Tests</title>
        <file>tests/e2e/settings.spec.ts</file>
        <details>Test settings page accessibility, form interactions, validation, persistence</details>
      </task>
      <task id="8" status="pending">
        <title>Run Verification</title>
        <details>pnpm lint, pnpm build, pnpm test - all must pass</details>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-2.6.1" title="Settings Page Fields">
      <given>I am on the Settings page</given>
      <when>the page loads</when>
      <then>I see form fields for name and base currency</then>
    </criterion>
    <criterion id="AC-2.6.2" title="Base Currency Dropdown">
      <given>I am on the Settings page</given>
      <when>I click the base currency dropdown</when>
      <then>I see options: USD, EUR, GBP, BRL, CAD, AUD, JPY, CHF and my current currency is pre-selected</then>
    </criterion>
    <criterion id="AC-2.6.3" title="Currency Change Triggers Recalculation">
      <given>I have portfolio assets</given>
      <when>I change my base currency</when>
      <then>portfolio values are recalculated using updated exchange rates and recommendation cache is invalidated</then>
    </criterion>
    <criterion id="AC-2.6.4" title="Auto-Save with Success Indicator">
      <given>I modify my name or base currency</given>
      <when>I blur the field or select a new currency</when>
      <then>changes are saved automatically and a subtle checkmark success indicator appears briefly</then>
    </criterion>
    <criterion id="AC-2.6.5" title="Name Field Validation">
      <given>I am editing my name</given>
      <when>I enter more than 100 characters</when>
      <then>the input is truncated or blocked at 100 characters and a validation message appears</then>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Technical Specification Epic 2</title>
        <section>Story 2.6</section>
        <snippet>Defines acceptance criteria for profile settings page with name field (100 char limit) and base currency dropdown (8 currencies). Auto-save with success indicator.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.6</section>
        <snippet>Profile Settings and Base Currency - FR6 (Update profile), FR40 (Set base currency). User can update profile and set preferred display currency.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Data Access Layer, Caching Strategy</section>
        <snippet>Drizzle ORM for type-safe database access. Vercel KV for caching with namespace pattern recs:${userId}. Cache invalidation required on currency change.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/2-5-password-reset-flow.md</path>
        <title>Previous Story (2.5)</title>
        <section>Dev Agent Record</section>
        <snippet>Patterns: React Hook Form + Zod, sonner toast, API route structure with withAuth middleware. Files: src/app/api/auth/ routes as templates.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>src/lib/db/schema.ts</path>
        <kind>schema</kind>
        <symbol>users</symbol>
        <lines>22-34</lines>
        <reason>Users table defines name (varchar 100), baseCurrency (varchar 3, default USD). Direct target for updates.</reason>
      </file>
      <file>
        <path>src/app/(dashboard)/settings/page.tsx</path>
        <kind>page</kind>
        <symbol>SettingsPage</symbol>
        <lines>1-13</lines>
        <reason>Existing placeholder page to replace. Shows "Coming soon" - needs profile form integration.</reason>
      </file>
      <file>
        <path>src/app/(dashboard)/layout.tsx</path>
        <kind>layout</kind>
        <symbol>DashboardLayout</symbol>
        <lines>16-42</lines>
        <reason>Parent layout with VerificationGate, SidebarProvider. Settings page inherits this layout.</reason>
      </file>
      <file>
        <path>src/lib/auth/service.ts</path>
        <kind>service</kind>
        <symbol>getSafeUserById, findUserById</symbol>
        <lines>101-116</lines>
        <reason>User lookup functions to reuse. Pattern for database operations with Drizzle.</reason>
      </file>
      <file>
        <path>src/app/api/auth/me/route.ts</path>
        <kind>api-route</kind>
        <symbol>GET</symbol>
        <lines>36-74</lines>
        <reason>Pattern for authenticated API routes using withAuth wrapper. Returns user with baseCurrency.</reason>
      </file>
      <file>
        <path>src/components/dashboard/app-sidebar.tsx</path>
        <kind>component</kind>
        <symbol>AppSidebar, navItems</symbol>
        <lines>43-49</lines>
        <reason>Settings link already exists at /settings (line 48). Verify active state works.</reason>
      </file>
      <file>
        <path>src/lib/cache/recommendations.ts</path>
        <kind>service</kind>
        <symbol>invalidateRecommendations</symbol>
        <lines>148-151</lines>
        <reason>Cache invalidation function to call when currency changes. Key pattern: recs:${userId}.</reason>
      </file>
      <file>
        <path>tests/unit/auth/password-reset.test.ts</path>
        <kind>test</kind>
        <symbol>describe blocks</symbol>
        <lines>1-50</lines>
        <reason>Test pattern with Vitest, vi.mock for database, describe/it structure.</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <production>
          <pkg name="next" version="16.0.5" />
          <pkg name="react" version="19.2.0" />
          <pkg name="react-hook-form" version="^7.67.0" />
          <pkg name="@hookform/resolvers" version="^5.2.2" />
          <pkg name="zod" version="^4.1.13" />
          <pkg name="drizzle-orm" version="^0.44.7" />
          <pkg name="sonner" version="^2.0.7" />
          <pkg name="lucide-react" version="^0.555.0" />
          <pkg name="@radix-ui/react-select" version="^2.2.6" />
          <pkg name="@vercel/kv" version="^3.0.0" />
        </production>
        <dev>
          <pkg name="vitest" version="^4.0.14" />
          <pkg name="@playwright/test" version="^1.57.0" />
          <pkg name="typescript" version="^5" />
        </dev>
      </node>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface>
      <name>GET /api/user/profile</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/user/profile -> { user: { id, email, name, baseCurrency } }</signature>
      <path>src/app/api/user/profile/route.ts (to create)</path>
    </interface>
    <interface>
      <name>PATCH /api/user/profile</name>
      <kind>REST endpoint</kind>
      <signature>PATCH /api/user/profile { name?: string, baseCurrency?: string } -> { user }</signature>
      <path>src/app/api/user/profile/route.ts (to create)</path>
    </interface>
    <interface>
      <name>updateUserProfile</name>
      <kind>function signature</kind>
      <signature>updateUserProfile(userId: string, data: { name?: string; baseCurrency?: string }): Promise&lt;User&gt;</signature>
      <path>src/lib/services/user-service.ts (to create)</path>
    </interface>
    <interface>
      <name>withAuth</name>
      <kind>middleware wrapper</kind>
      <signature>withAuth&lt;T&gt;(handler: (req, session) => Response): NextHandler</signature>
      <path>src/lib/auth/middleware.ts</path>
    </interface>
    <interface>
      <name>invalidateRecommendations</name>
      <kind>function signature</kind>
      <signature>invalidateRecommendations(userId: string): Promise&lt;void&gt;</signature>
      <path>src/lib/cache/recommendations.ts</path>
    </interface>
  </interfaces>

  <constraints>
    <constraint type="validation">Name field max 100 characters (matches DB schema varchar(100))</constraint>
    <constraint type="validation">baseCurrency must be one of: USD, EUR, GBP, BRL, CAD, AUD, JPY, CHF</constraint>
    <constraint type="pattern">Use withAuth middleware wrapper for authenticated API routes</constraint>
    <constraint type="pattern">Use React Hook Form + Zod for form validation (established in Epic 2)</constraint>
    <constraint type="pattern">Use sonner toast for error notifications</constraint>
    <constraint type="cache">Call invalidateRecommendations(userId) when baseCurrency changes</constraint>
    <constraint type="architecture">Service functions in src/lib/services/ for business logic</constraint>
    <constraint type="testing">Unit tests in tests/unit/, E2E tests in tests/e2e/</constraint>
    <constraint type="testing">Follow existing test patterns from password-reset.test.ts</constraint>
  </constraints>

  <tests>
    <standards>
      Vitest for unit tests with vi.mock for database mocking. Playwright for E2E tests.
      Tests follow describe/it/expect pattern. Mock external dependencies (db, cache).
      E2E tests use page.goto(), page.fill(), page.click(), expect(page.locator()).
    </standards>
    <locations>
      <location>tests/unit/services/user-service.test.ts (new)</location>
      <location>tests/e2e/settings.spec.ts (new)</location>
    </locations>
    <ideas>
      <idea ac="AC-2.6.1">E2E: Navigate to /settings, verify name input and currency select are visible</idea>
      <idea ac="AC-2.6.2">E2E: Click currency dropdown, verify all 8 options present, verify current selection</idea>
      <idea ac="AC-2.6.3">Unit: Mock cache service, verify invalidateRecommendations called on currency update</idea>
      <idea ac="AC-2.6.4">E2E: Change name, verify success checkmark appears, verify API call made</idea>
      <idea ac="AC-2.6.5">E2E: Enter 101+ chars in name, verify truncation or validation error</idea>
      <idea ac="validation">Unit: Test updateUserProfile with invalid currency, expect validation error</idea>
      <idea ac="validation">Unit: Test updateUserProfile with name > 100 chars, expect validation error</idea>
      <idea ac="persistence">E2E: Update currency, refresh page, verify change persisted</idea>
    </ideas>
  </tests>
</story-context>
