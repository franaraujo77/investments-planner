<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>8</storyId>
    <title>App Shell &amp; Layout Components</title>
    <status>drafted</status>
    <generatedAt>2025-12-01</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-8-app-shell-layout-components.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>the application shell with sidebar navigation</iWant>
    <soThat>I can navigate between different sections of the app</soThat>
    <tasks>
      <task id="1" ac="1,3">Create dashboard layout structure
        <subtask>Create src/app/(dashboard)/layout.tsx with sidebar + main content area</subtask>
        <subtask>Configure layout to use shadcn/ui SidebarProvider</subtask>
        <subtask>Set up responsive container with proper padding</subtask>
        <subtask>Add header area for user menu (placeholder)</subtask>
      </task>
      <task id="2" ac="1,4,5">Implement sidebar component
        <subtask>Create src/components/dashboard/sidebar.tsx using shadcn/ui Sidebar</subtask>
        <subtask>Configure sidebar width: 240px on desktop</subtask>
        <subtask>Add navigation items: Dashboard, Portfolio, Criteria, History, Settings</subtask>
        <subtask>Add icons for each navigation item (use lucide-react)</subtask>
        <subtask>Implement active route highlighting using usePathname()</subtask>
        <subtask>Add user avatar/menu placeholder at bottom of sidebar</subtask>
      </task>
      <task id="3" ac="2,6">Implement responsive behavior
        <subtask>Configure sidebar collapse to icons on tablet (md breakpoint: 768px)</subtask>
        <subtask>Implement hamburger menu trigger on mobile (sm breakpoint: 640px)</subtask>
        <subtask>Add slide-out panel (Sheet) for mobile navigation</subtask>
        <subtask>Ensure smooth transition animations</subtask>
        <subtask>Test responsive behavior at all breakpoints</subtask>
      </task>
      <task id="4" ac="3">Create Focus Mode placeholder
        <subtask>Create src/app/(dashboard)/page.tsx (dashboard home)</subtask>
        <subtask>Add Focus Mode placeholder content</subtask>
        <subtask>Include skeleton loading states for recommendations</subtask>
        <subtask>Add Welcome message and placeholder metrics row</subtask>
      </task>
      <task id="5" ac="1-6">Add keyboard accessibility
        <subtask>Ensure Tab navigation works through sidebar items</subtask>
        <subtask>Add proper aria-labels to navigation elements</subtask>
        <subtask>Implement focus states for interactive elements</subtask>
        <subtask>Test keyboard navigation flow</subtask>
      </task>
      <task id="6" ac="4">Create placeholder pages for routes
        <subtask>Create src/app/(dashboard)/portfolio/page.tsx (placeholder)</subtask>
        <subtask>Create src/app/(dashboard)/criteria/page.tsx (placeholder)</subtask>
        <subtask>Create src/app/(dashboard)/history/page.tsx (placeholder)</subtask>
        <subtask>Create src/app/(dashboard)/settings/page.tsx (placeholder)</subtask>
        <subtask>Each page should show title and Coming soon message</subtask>
      </task>
      <task id="7" ac="1-6">Add unit and E2E tests
        <subtask>Create tests/unit/components/sidebar.test.tsx - Test sidebar renders with all nav items</subtask>
        <subtask>Create tests/e2e/layout.spec.ts - Test responsive behavior</subtask>
        <subtask>Test active route highlighting</subtask>
        <subtask>Test mobile hamburger menu opens/closes</subtask>
        <subtask>Test keyboard navigation</subtask>
      </task>
      <task id="8" ac="1-6">Verify build and lint
        <subtask>Run pnpm lint - No errors</subtask>
        <subtask>Run pnpm build - Build succeeds</subtask>
        <subtask>Run pnpm test - All tests pass</subtask>
        <subtask>Verify no TypeScript errors with pnpm exec tsc --noEmit</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">Dashboard displays Command Center layout with persistent sidebar (240px on desktop)</ac>
    <ac id="2">Sidebar collapses to icons on tablet, hamburger menu on mobile</ac>
    <ac id="3">Main content area displays Focus Mode recommendations placeholder</ac>
    <ac id="4">Sidebar contains: Dashboard, Portfolio, Criteria, History, Settings</ac>
    <ac id="5">Active route is highlighted in sidebar</ac>
    <ac id="6">Layout responds to breakpoints: sm (640px), md (768px), lg (1024px)</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>Section 4: Design Direction - Hybrid Command Center + Focus Mode</section>
        <snippet>App Shell uses Command Center layout with persistent sidebar navigation. Core View uses Focus Mode for monthly recommendations. Information Architecture: Dashboard (Focus Mode - default landing), Portfolio, Criteria, History, Settings.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Story 1.8: App Shell &amp; Layout Components</section>
        <snippet>Dashboard displays Command Center layout with persistent sidebar (240px on desktop). Sidebar collapses to icons on tablet, hamburger menu on mobile. Layout responds to breakpoints: sm (640px), md (768px), lg (1024px).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Project Structure</section>
        <snippet>Next.js 15 App Router with src/ directory. Components in src/components/, pages in src/app/. Uses shadcn/ui component library with Tailwind CSS v4.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Definitions</title>
        <section>Epic 1, Story 1.8</section>
        <snippet>Story 1.8: As a user, I want the application shell with sidebar navigation, so that I can navigate between different sections of the app.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/1-7-vitest-playwright-testing-setup.md</path>
        <title>Previous Story: Testing Setup</title>
        <section>Completion Notes</section>
        <snippet>Testing infrastructure fully configured. Vitest for unit tests in tests/unit/, Playwright for E2E in tests/e2e/. Coverage via pnpm test:coverage. Path aliases (@/) configured.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>src/components/ui/sidebar.tsx</path>
        <kind>component</kind>
        <symbol>SidebarProvider, Sidebar, SidebarContent, SidebarHeader, SidebarFooter, SidebarMenu, SidebarMenuItem, SidebarMenuButton, useSidebar</symbol>
        <lines>1-724</lines>
        <reason>Complete shadcn/ui Sidebar component already installed. Provides all primitives needed: SidebarProvider, Sidebar, SidebarMenu, SidebarMenuItem, SidebarMenuButton with isActive prop. Includes mobile sheet behavior and keyboard shortcut (Ctrl+B).</reason>
      </file>
      <file>
        <path>src/components/ui/sheet.tsx</path>
        <kind>component</kind>
        <symbol>Sheet, SheetContent, SheetTrigger</symbol>
        <reason>Slide-out panel component for mobile navigation. Already imported and used by sidebar.tsx for mobile behavior.</reason>
      </file>
      <file>
        <path>src/components/ui/skeleton.tsx</path>
        <kind>component</kind>
        <symbol>Skeleton</symbol>
        <reason>Loading placeholder component for Focus Mode recommendations skeleton states.</reason>
      </file>
      <file>
        <path>src/components/ui/tooltip.tsx</path>
        <kind>component</kind>
        <symbol>Tooltip, TooltipContent, TooltipProvider, TooltipTrigger</symbol>
        <reason>Tooltip for collapsed sidebar icons on tablet view.</reason>
      </file>
      <file>
        <path>src/components/ui/button.tsx</path>
        <kind>component</kind>
        <symbol>Button</symbol>
        <reason>Button component for hamburger menu trigger and navigation actions.</reason>
      </file>
      <file>
        <path>src/components/ui/dropdown-menu.tsx</path>
        <kind>component</kind>
        <symbol>DropdownMenu, DropdownMenuContent, DropdownMenuItem</symbol>
        <reason>For user avatar dropdown menu in sidebar footer.</reason>
      </file>
      <file>
        <path>src/hooks/use-mobile.ts</path>
        <kind>hook</kind>
        <symbol>useIsMobile</symbol>
        <lines>1-19</lines>
        <reason>Mobile detection hook with 768px breakpoint. Already implemented and used by sidebar.tsx. Returns boolean for responsive behavior.</reason>
      </file>
      <file>
        <path>src/app/layout.tsx</path>
        <kind>layout</kind>
        <symbol>RootLayout</symbol>
        <lines>1-35</lines>
        <reason>Root layout with Geist fonts and global CSS. Dashboard layout will be nested under (dashboard) route group.</reason>
      </file>
      <file>
        <path>src/app/page.tsx</path>
        <kind>page</kind>
        <symbol>Home</symbol>
        <reason>Current root page. Will be replaced/redirected to dashboard when layout is implemented.</reason>
      </file>
      <file>
        <path>src/lib/utils.ts</path>
        <kind>utility</kind>
        <symbol>cn</symbol>
        <reason>Class name utility (clsx + tailwind-merge) for conditional styling.</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <production>
          <package name="next" version="16.0.5">React framework with App Router</package>
          <package name="react" version="19.2.0">UI library</package>
          <package name="react-dom" version="19.2.0">React DOM renderer</package>
          <package name="lucide-react" version="^0.555.0">Icon library - use LayoutDashboard, Briefcase, ListChecks, History, Settings, Menu, X</package>
          <package name="class-variance-authority" version="^0.7.1">Component variant styling</package>
          <package name="clsx" version="^2.1.1">Conditional class names</package>
          <package name="tailwind-merge" version="^3.4.0">Merge Tailwind classes</package>
          <package name="@radix-ui/react-slot" version="^1.2.4">Slot component for composition</package>
          <package name="@radix-ui/react-dialog" version="^1.1.15">Dialog/Sheet primitive</package>
          <package name="@radix-ui/react-tooltip" version="^1.2.8">Tooltip primitive</package>
          <package name="@radix-ui/react-separator" version="^1.1.8">Separator component</package>
          <package name="@radix-ui/react-dropdown-menu" version="^2.1.16">Dropdown menu primitive</package>
        </production>
        <development>
          <package name="typescript" version="^5">Type checking</package>
          <package name="tailwindcss" version="^4">CSS framework</package>
          <package name="vitest" version="^4.0.14">Unit testing</package>
          <package name="@playwright/test" version="^1.57.0">E2E testing</package>
          <package name="eslint" version="^9">Linting</package>
        </development>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Use Next.js App Router with route groups: (dashboard) for authenticated layout</constraint>
    <constraint type="pattern">Follow shadcn/ui component patterns - copy-paste model, customize as needed</constraint>
    <constraint type="pattern">Use Tailwind CSS for all styling - no CSS modules or styled-components</constraint>
    <constraint type="pattern">Client components must have "use client" directive at top</constraint>
    <constraint type="pattern">Use @/ path alias for all imports (e.g., @/components/ui/button)</constraint>
    <constraint type="layer">Layout components go in src/app/(dashboard)/layout.tsx</constraint>
    <constraint type="layer">Reusable components go in src/components/dashboard/</constraint>
    <constraint type="layer">UI primitives in src/components/ui/ - do not modify unless necessary</constraint>
    <constraint type="testing">Unit tests in tests/unit/, E2E tests in tests/e2e/</constraint>
    <constraint type="testing">Follow AAA pattern (Arrange-Act-Assert) for unit tests</constraint>
    <constraint type="accessibility">WCAG 2.1 AA compliance - proper aria-labels, keyboard navigation, focus states</constraint>
    <constraint type="responsive">Mobile-first approach - sm (640px), md (768px), lg (1024px) breakpoints</constraint>
    <constraint type="performance">No unnecessary re-renders - use React.memo where appropriate</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>useSidebar</name>
      <kind>React Hook</kind>
      <signature>function useSidebar(): { state: "expanded" | "collapsed"; open: boolean; setOpen: (open: boolean) => void; openMobile: boolean; setOpenMobile: (open: boolean) => void; isMobile: boolean; toggleSidebar: () => void }</signature>
      <path>src/components/ui/sidebar.tsx</path>
    </interface>
    <interface>
      <name>useIsMobile</name>
      <kind>React Hook</kind>
      <signature>function useIsMobile(): boolean</signature>
      <path>src/hooks/use-mobile.ts</path>
    </interface>
    <interface>
      <name>usePathname</name>
      <kind>Next.js Hook</kind>
      <signature>function usePathname(): string</signature>
      <path>next/navigation</path>
    </interface>
    <interface>
      <name>SidebarMenuButton</name>
      <kind>React Component</kind>
      <signature>SidebarMenuButton({ asChild?: boolean; isActive?: boolean; tooltip?: string; variant?: "default" | "outline"; size?: "default" | "sm" | "lg"; children: ReactNode })</signature>
      <path>src/components/ui/sidebar.tsx</path>
    </interface>
    <interface>
      <name>Navigation Item</name>
      <kind>Data Structure</kind>
      <signature>{ label: string; path: string; icon: LucideIcon }</signature>
      <path>To be created in sidebar.tsx</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Unit tests use Vitest with globals:false. Tests follow AAA pattern (Arrange-Act-Assert).
      E2E tests use Playwright with Chromium. CI runs in headless mode with GitHub reporter.
      Test files use .test.ts for unit tests and .spec.ts for E2E tests.
      Coverage threshold: 80% for lines, functions, branches, statements.
      React component tests may need jsdom environment (update vitest.config.ts if testing TSX).
    </standards>
    <locations>
      <location>tests/unit/ - Unit tests (Vitest)</location>
      <location>tests/unit/components/ - Component unit tests (create this directory)</location>
      <location>tests/e2e/ - E2E tests (Playwright)</location>
      <location>tests/integration/ - Integration tests (Vitest)</location>
    </locations>
    <ideas>
      <idea ac="1,4">Unit test: Sidebar renders all 5 navigation items (Dashboard, Portfolio, Criteria, History, Settings)</idea>
      <idea ac="5">Unit test: Navigation item with matching pathname has isActive=true</idea>
      <idea ac="2">E2E test: On mobile viewport (375px), hamburger menu is visible and sidebar is hidden</idea>
      <idea ac="2">E2E test: Clicking hamburger opens sheet with navigation items</idea>
      <idea ac="6">E2E test: On tablet viewport (768px), sidebar shows icon-only mode</idea>
      <idea ac="6">E2E test: On desktop viewport (1024px+), sidebar shows full width (240px)</idea>
      <idea ac="5">E2E test: Clicking navigation item highlights it and navigates to route</idea>
      <idea ac="3">E2E test: Dashboard page shows Focus Mode placeholder content</idea>
      <idea ac="1-6">E2E test: Keyboard navigation (Tab) cycles through sidebar items</idea>
    </ideas>
  </tests>
</story-context>
