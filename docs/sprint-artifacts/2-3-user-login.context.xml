<story-context id="2-3-user-login" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>3</storyId>
    <title>User Login</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-3-user-login.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>registered user</asA>
    <iWant>to log in securely with my email and password</iWant>
    <soThat>I can access my portfolio and investment recommendations</soThat>
    <tasks>
      <task id="1" status="pending">
        <title>Create login API endpoint</title>
        <ac>1, 3, 4, 5, 6</ac>
        <note>API endpoint exists at src/app/api/auth/login/route.ts from Story 1.3 but needs enhancements: add emailVerified check (return 403 for unverified), add deletedAt check (treat soft-deleted as non-existent)</note>
      </task>
      <task id="2" status="pending">
        <title>Update login page with functional form</title>
        <ac>1, 2, 3, 4</ac>
        <note>Create login-form.tsx client component with email, password, remember me checkbox, validation, error display, and lockout countdown</note>
      </task>
      <task id="3" status="pending">
        <title>Implement lockout countdown display</title>
        <ac>4</ac>
        <note>Parse retryAfter from 429 response, show countdown timer, disable form during lockout, persist across page refresh</note>
      </task>
      <task id="4" status="pending">
        <title>Create /api/auth/me endpoint</title>
        <ac>1</ac>
        <note>Endpoint already exists at src/app/api/auth/me/route.ts - verify it meets requirements</note>
      </task>
      <task id="5" status="pending">
        <title>Write unit tests</title>
        <ac>1-6</ac>
        <note>Create tests/unit/auth/login.test.ts with tests for valid login, invalid credentials, rate limiting, remember me</note>
      </task>
      <task id="6" status="pending">
        <title>Write E2E tests</title>
        <ac>1-4</ac>
        <note>Create tests/e2e/login.spec.ts with page render, form validation, login flow, lockout display tests</note>
      </task>
      <task id="7" status="pending">
        <title>Verify build, lint, and tests</title>
        <ac>1-6</ac>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-2.3.1">Valid credentials redirect to dashboard with recommendations displayed</criterion>
    <criterion id="AC-2.3.2">Login form has email, password fields and "Remember me" checkbox</criterion>
    <criterion id="AC-2.3.3">Failed login shows "Invalid credentials" error (no email/password hints for security)</criterion>
    <criterion id="AC-2.3.4">5 failed attempts in 1 hour trigger 15-minute lockout with countdown display</criterion>
    <criterion id="AC-2.3.5">Successful login stores JWT access token in httpOnly cookie (15min expiry)</criterion>
    <criterion id="AC-2.3.6">"Remember me" extends refresh token to 30 days (default 7 days)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>Story 2.3: User Login</section>
        <snippet>Login flow with rate limiting: Check rate limit (5 per hour per IP), verify credentials, generate JWT tokens (15min access, 7d/30d refresh), set httpOnly cookies.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.3: User Login</section>
        <snippet>As a registered user, I want to log in securely so that I can access my portfolio and recommendations. Prerequisites: Story 2.2.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Authentication</section>
        <snippet>Custom auth with JWT + refresh tokens. Access tokens 15min expiry, refresh tokens 7d (30d with remember me). httpOnly, secure, sameSite=strict cookies.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>FR3</section>
        <snippet>Users can log in securely and maintain authenticated sessions.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/2-2-email-verification.md</path>
        <title>Previous Story</title>
        <section>Dev Agent Record</section>
        <snippet>Login page placeholder created with UI structure. Rate limiting, JWT, cookie utilities all ready. VerificationGate blocks unverified users from dashboard.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>src/app/api/auth/login/route.ts</path>
        <kind>api-route</kind>
        <symbol>POST</symbol>
        <lines>1-177</lines>
        <reason>Existing login API from Story 1.3. NEEDS ENHANCEMENT: Add emailVerified check (return 403 for unverified users), add deletedAt check (treat soft-deleted as non-existent). Currently allows unverified users to login.</reason>
      </file>
      <file>
        <path>src/app/api/auth/me/route.ts</path>
        <kind>api-route</kind>
        <symbol>GET</symbol>
        <lines>1-74</lines>
        <reason>Existing /api/auth/me endpoint. Already functional - returns user data for authenticated requests.</reason>
      </file>
      <file>
        <path>src/app/(auth)/login/page.tsx</path>
        <kind>page</kind>
        <symbol>LoginPage</symbol>
        <lines>1-103</lines>
        <reason>Existing login page placeholder with UI structure. NEEDS ENHANCEMENT: Replace placeholder form with functional login-form.tsx client component.</reason>
      </file>
      <file>
        <path>src/lib/auth/rate-limit.ts</path>
        <kind>service</kind>
        <symbol>checkRateLimit, recordFailedAttempt, clearRateLimit, getClientIp</symbol>
        <lines>1-329</lines>
        <reason>Rate limiting infrastructure. Reuse for login rate limiting.</reason>
      </file>
      <file>
        <path>src/lib/auth/jwt.ts</path>
        <kind>service</kind>
        <symbol>signAccessToken, signRefreshToken, verifyAccessToken, verifyRefreshToken</symbol>
        <lines>1-226</lines>
        <reason>JWT utilities for token generation and verification. Already used by login API.</reason>
      </file>
      <file>
        <path>src/lib/auth/cookies.ts</path>
        <kind>service</kind>
        <symbol>setAuthCookies, clearAuthCookies, getAccessToken, getRefreshToken</symbol>
        <lines>1-109</lines>
        <reason>Secure cookie management. Already used by login API.</reason>
      </file>
      <file>
        <path>src/lib/auth/password.ts</path>
        <kind>service</kind>
        <symbol>verifyPassword, hashPassword, validatePassword</symbol>
        <lines>1-75</lines>
        <reason>Password verification with bcrypt. Already used by login API.</reason>
      </file>
      <file>
        <path>src/lib/auth/service.ts</path>
        <kind>service</kind>
        <symbol>findUserByEmail, storeRefreshToken, getSafeUserById</symbol>
        <lines>1-345</lines>
        <reason>Database operations for auth. Already used by login API.</reason>
      </file>
      <file>
        <path>src/lib/auth/constants.ts</path>
        <kind>constants</kind>
        <symbol>AUTH_CONSTANTS, COOKIE_NAMES, AUTH_MESSAGES</symbol>
        <lines>1-105</lines>
        <reason>Auth configuration constants. Token expiry, rate limits, error messages.</reason>
      </file>
      <file>
        <path>src/lib/auth/types.ts</path>
        <kind>types</kind>
        <symbol>JwtPayload, AuthResponse, AuthError, LoginRequest, RateLimitResult</symbol>
        <lines>1-132</lines>
        <reason>TypeScript types for auth system.</reason>
      </file>
      <file>
        <path>src/lib/auth/middleware.ts</path>
        <kind>middleware</kind>
        <symbol>withAuth</symbol>
        <reason>Authentication middleware wrapper for protected API routes.</reason>
      </file>
      <file>
        <path>src/middleware.ts</path>
        <kind>middleware</kind>
        <symbol>middleware</symbol>
        <reason>Route protection middleware. Redirects unauthenticated users from dashboard routes.</reason>
      </file>
      <file>
        <path>src/components/auth/verification-gate.tsx</path>
        <kind>component</kind>
        <symbol>VerificationGate</symbol>
        <reason>Client-side guard for email verification. Redirects unverified users to verify-pending.</reason>
      </file>
      <file>
        <path>src/components/auth/registration-form.tsx</path>
        <kind>component</kind>
        <symbol>RegistrationForm</symbol>
        <reason>Reference implementation for form patterns. Use as template for login-form.tsx.</reason>
      </file>
      <file>
        <path>src/app/(auth)/verify/verify-content.tsx</path>
        <kind>component</kind>
        <symbol>VerifyContent</symbol>
        <reason>Reference for client component patterns with Suspense, useSearchParams, toast notifications.</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <package name="next" version="16.0.5">React framework with App Router</package>
        <package name="react" version="19.2.0">UI library</package>
        <package name="react-hook-form" version="^7.67.0">Form state management</package>
        <package name="@hookform/resolvers" version="^5.2.2">Zod integration for react-hook-form</package>
        <package name="zod" version="^4.1.13">Schema validation</package>
        <package name="jose" version="^6.1.2">JWT signing and verification</package>
        <package name="bcrypt" version="^6.0.0">Password hashing</package>
        <package name="sonner" version="^2.0.7">Toast notifications</package>
        <package name="lucide-react" version="^0.555.0">Icons (eye, eye-off for password toggle)</package>
      </node>
      <devDependencies>
        <package name="vitest" version="^4.0.14">Unit testing framework</package>
        <package name="@playwright/test" version="^1.57.0">E2E testing framework</package>
        <package name="typescript" version="^5">TypeScript compiler</package>
      </devDependencies>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="security">No email enumeration: return same "Invalid credentials" for missing user and wrong password</constraint>
    <constraint type="security">Rate limiting: 5 attempts per hour per IP, 15-minute lockout window</constraint>
    <constraint type="security">Unverified users cannot login (must verify email first) - return 403</constraint>
    <constraint type="security">Soft-deleted users treated as non-existent</constraint>
    <constraint type="security">All cookies must be httpOnly, secure (in production), sameSite=strict</constraint>
    <constraint type="security">Passwords verified using timing-safe bcrypt comparison</constraint>
    <constraint type="architecture">Client components must use "use client" directive</constraint>
    <constraint type="architecture">Use Suspense boundaries for components using useSearchParams or router hooks</constraint>
    <constraint type="architecture">API routes in src/app/api/ following Next.js App Router conventions</constraint>
    <constraint type="testing">Maintain existing 287 unit tests passing baseline</constraint>
    <constraint type="testing">Follow existing E2E patterns from tests/e2e/registration.spec.ts and tests/e2e/verification.spec.ts</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/auth/login</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/auth/login { email: string, password: string, remember?: boolean } => { user: SafeUser, accessToken: string } | { error: string, code: string, retryAfter?: number }</signature>
      <path>src/app/api/auth/login/route.ts</path>
      <note>Existing endpoint needs enhancement for emailVerified and deletedAt checks</note>
    </interface>
    <interface>
      <name>GET /api/auth/me</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/auth/me => { user: SafeUser } | { error: string, code: string }</signature>
      <path>src/app/api/auth/me/route.ts</path>
      <note>Existing endpoint - fully functional</note>
    </interface>
    <interface>
      <name>checkRateLimit</name>
      <kind>function</kind>
      <signature>checkRateLimit(ip: string): RateLimitResult</signature>
      <path>src/lib/auth/rate-limit.ts</path>
    </interface>
    <interface>
      <name>recordFailedAttempt</name>
      <kind>function</kind>
      <signature>recordFailedAttempt(ip: string): void</signature>
      <path>src/lib/auth/rate-limit.ts</path>
    </interface>
    <interface>
      <name>clearRateLimit</name>
      <kind>function</kind>
      <signature>clearRateLimit(ip: string): void</signature>
      <path>src/lib/auth/rate-limit.ts</path>
    </interface>
    <interface>
      <name>signAccessToken</name>
      <kind>function</kind>
      <signature>signAccessToken(payload: { userId: string, email: string }): Promise&lt;string&gt;</signature>
      <path>src/lib/auth/jwt.ts</path>
    </interface>
    <interface>
      <name>signRefreshToken</name>
      <kind>function</kind>
      <signature>signRefreshToken(payload: { userId: string, tokenId: string }, remember?: boolean): Promise&lt;string&gt;</signature>
      <path>src/lib/auth/jwt.ts</path>
    </interface>
    <interface>
      <name>verifyPassword</name>
      <kind>function</kind>
      <signature>verifyPassword(password: string, hash: string): Promise&lt;boolean&gt;</signature>
      <path>src/lib/auth/password.ts</path>
    </interface>
    <interface>
      <name>findUserByEmail</name>
      <kind>function</kind>
      <signature>findUserByEmail(email: string): Promise&lt;User | null&gt;</signature>
      <path>src/lib/auth/service.ts</path>
    </interface>
    <interface>
      <name>setAuthCookies</name>
      <kind>function</kind>
      <signature>setAuthCookies(response: NextResponse, accessToken: string, refreshToken: string, remember?: boolean): void</signature>
      <path>src/lib/auth/cookies.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Unit tests use Vitest with test files in tests/unit/. E2E tests use Playwright with test files in tests/e2e/. Tests should use descriptive names following "should [expected behavior] when [condition]" pattern. Mock external dependencies. For auth tests, use the existing patterns from tests/unit/auth/rate-limit.test.ts and tests/unit/auth/jwt.test.ts.
    </standards>
    <locations>
      <location>tests/unit/auth/ - Unit tests for auth logic</location>
      <location>tests/e2e/ - E2E tests for user flows</location>
      <location>tests/integration/ - Integration tests</location>
    </locations>
    <ideas>
      <idea ac="AC-2.3.1">Test successful login returns user data and sets cookies, then redirects to dashboard</idea>
      <idea ac="AC-2.3.2">Test login form renders email input, password input, and remember me checkbox</idea>
      <idea ac="AC-2.3.3">Test failed login with wrong password shows "Invalid credentials"</idea>
      <idea ac="AC-2.3.3">Test failed login with non-existent email shows "Invalid credentials" (no enumeration)</idea>
      <idea ac="AC-2.3.3">Test unverified user login returns 403 with "Please verify your email first"</idea>
      <idea ac="AC-2.3.4">Test rate limiting triggers 429 after 5 failed attempts</idea>
      <idea ac="AC-2.3.4">Test lockout countdown displays correctly in UI</idea>
      <idea ac="AC-2.3.4">Test form is disabled during lockout period</idea>
      <idea ac="AC-2.3.5">Test access token cookie has correct attributes (httpOnly, secure, maxAge=900)</idea>
      <idea ac="AC-2.3.6">Test remember me extends refresh token to 30 days</idea>
      <idea ac="AC-2.3.6">Test default refresh token is 7 days without remember me</idea>
    </ideas>
  </tests>
</story-context>
