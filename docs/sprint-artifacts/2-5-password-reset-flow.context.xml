<story-context id="2-5-password-reset-flow" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>5</storyId>
    <title>Password Reset Flow</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-5-password-reset-flow.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user who forgot my password</asA>
    <iWant>to reset it via email</iWant>
    <soThat>I can regain access to my account</soThat>
    <tasks>
      <task id="1">Add Password Reset Service Functions to src/lib/auth/service.ts</task>
      <task id="2">Create Forgot Password API Route (POST /api/auth/forgot-password)</task>
      <task id="3">Create Reset Password API Route (POST /api/auth/reset-password)</task>
      <task id="4">Create Password Reset Email Template (already exists in email-service.ts)</task>
      <task id="5">Create Forgot Password Page (src/app/(auth)/forgot-password/page.tsx)</task>
      <task id="6">Create Reset Password Page (src/app/(auth)/reset-password/page.tsx)</task>
      <task id="7">Add Forgot Password Link to Login Page</task>
      <task id="8">Create Unit Tests (tests/unit/auth/password-reset.test.ts)</task>
      <task id="9">Create E2E Tests (tests/e2e/password-reset.spec.ts)</task>
      <task id="10">Run Verification (lint, build, test)</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-2.5.1" description="Forgot Password Form">
      Click "Forgot password?" on login shows email input form
    </criterion>
    <criterion id="AC-2.5.2" description="No Email Enumeration">
      Always return "If an account exists, a reset link has been sent" regardless of email existence
    </criterion>
    <criterion id="AC-2.5.3" description="Reset Link Expiration">
      Reset link expires in 1 hour
    </criterion>
    <criterion id="AC-2.5.4" description="Reset Password Form">
      Reset page shows new password form with complexity requirements
    </criterion>
    <criterion id="AC-2.5.5" description="Session Invalidation">
      Successful reset invalidates all existing refresh tokens
    </criterion>
    <criterion id="AC-2.5.6" description="Success Redirect">
      Redirect to login with "Password reset successful" toast
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/sprint-artifacts/tech-spec-epic-2.md" title="Epic 2 Technical Specification" section="Password Reset Flow" snippet="Detailed design for forgot password and reset password endpoints including token generation, hashing, and session invalidation flow."/>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Story 2.5: Password Reset Flow" snippet="User story and acceptance criteria for password reset feature."/>
      <doc path="docs/architecture.md" title="Architecture" section="Security Architecture" snippet="Token strategy, cookie configuration, and security controls including httpOnly, secure, sameSite settings."/>
      <doc path="docs/prd.md" title="Product Requirements" section="FR5" snippet="FR5: Users can reset their password via email verification."/>
    </docs>
    <code>
      <!-- Database Schema -->
      <file path="src/lib/db/schema.ts" kind="schema" symbol="passwordResetTokens" lines="134-150" reason="Password reset tokens table definition - already exists with tokenHash, expiresAt, usedAt fields"/>

      <!-- Auth Service -->
      <file path="src/lib/auth/service.ts" kind="service" symbol="deleteUserRefreshTokens" lines="208-210" reason="Invalidate all refresh tokens for user on password reset"/>
      <file path="src/lib/auth/service.ts" kind="service" symbol="findUserByEmail" lines="82-90" reason="Lookup user by email for reset flow"/>
      <file path="src/lib/auth/service.ts" kind="service" symbol="findUserById" lines="98-102" reason="Lookup user by ID from token"/>

      <!-- Password Utilities -->
      <file path="src/lib/auth/password.ts" kind="utility" symbol="hashPassword" lines="54-61" reason="Hash new password with bcrypt cost factor 12"/>
      <file path="src/lib/auth/password.ts" kind="utility" symbol="verifyPassword" lines="72-75" reason="Not needed for reset but available"/>

      <!-- Validation Schemas -->
      <file path="src/lib/auth/validation.ts" kind="schema" symbol="passwordSchema" lines="28-43" reason="Password complexity validation - reuse for reset form"/>
      <file path="src/lib/auth/validation.ts" kind="schema" symbol="emailSchema" lines="18-23" reason="Email validation for forgot password form"/>

      <!-- Auth Constants -->
      <file path="src/lib/auth/constants.ts" kind="constants" symbol="AUTH_CONSTANTS.PASSWORD_RESET_TOKEN_EXPIRY" lines="28" reason="1 hour expiry constant already defined"/>
      <file path="src/lib/auth/constants.ts" kind="constants" symbol="AUTH_MESSAGES" lines="89-106" reason="Error messages for auth flows"/>

      <!-- Email Service (ALREADY IMPLEMENTED!) -->
      <file path="src/lib/email/email-service.ts" kind="service" symbol="sendPasswordResetEmail" lines="255-258" reason="Password reset email sending - ALREADY EXISTS"/>
      <file path="src/lib/email/email-service.ts" kind="template" symbol="generatePasswordResetEmailTemplate" lines="135-196" reason="Reset email HTML/text template - ALREADY EXISTS"/>

      <!-- Existing Auth Pages (patterns to follow) -->
      <file path="src/app/(auth)/login/login-form.tsx" kind="component" symbol="LoginForm" lines="1-258" reason="Reference for form patterns, error handling, loading states, toast notifications"/>
      <file path="src/app/(auth)/login/page.tsx" kind="page" symbol="LoginPage" reason="Add 'Forgot password?' link here"/>
      <file path="src/app/(auth)/layout.tsx" kind="layout" reason="Auth page layout - reuse for forgot/reset pages"/>
      <file path="src/app/(auth)/register/page.tsx" kind="page" reason="Reference for page structure and PasswordStrengthMeter usage"/>

      <!-- Components -->
      <file path="src/components/auth/logout-button.tsx" kind="component" reason="Reference for auth component patterns"/>

      <!-- Existing Tests (patterns to follow) -->
      <file path="tests/unit/auth/password.test.ts" kind="test" reason="Password utility test patterns"/>
      <file path="tests/unit/auth/validation.test.ts" kind="test" reason="Validation schema test patterns"/>
      <file path="tests/e2e/login.spec.ts" kind="test" reason="E2E auth flow test patterns"/>
      <file path="tests/e2e/registration.spec.ts" kind="test" reason="E2E form test patterns"/>
    </code>
    <dependencies>
      <npm>
        <package name="bcrypt" version="^6.0.0" reason="Password hashing"/>
        <package name="jose" version="^6.1.2" reason="JWT handling (not used for reset tokens per spec)"/>
        <package name="zod" version="^4.1.13" reason="Input validation"/>
        <package name="resend" version="^6.5.2" reason="Email sending"/>
        <package name="react-hook-form" version="^7.67.0" reason="Form state management"/>
        <package name="@hookform/resolvers" version="^5.2.2" reason="Zod integration with react-hook-form"/>
        <package name="sonner" version="^2.0.7" reason="Toast notifications"/>
        <package name="lucide-react" version="^0.555.0" reason="Icons (Eye, EyeOff, Loader2, etc.)"/>
      </npm>
      <dev>
        <package name="vitest" version="^4.0.14" reason="Unit testing"/>
        <package name="@playwright/test" version="^1.57.0" reason="E2E testing"/>
      </dev>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface name="POST /api/auth/forgot-password" kind="REST endpoint">
      <signature>Request: { email: string } Response: { message: string }</signature>
      <path>src/app/api/auth/forgot-password/route.ts</path>
      <notes>Always return same message - no email enumeration</notes>
    </interface>
    <interface name="POST /api/auth/reset-password" kind="REST endpoint">
      <signature>Request: { token: string, newPassword: string } Response: { success: boolean } or error</signature>
      <path>src/app/api/auth/reset-password/route.ts</path>
      <notes>Hash incoming token for lookup, validate password complexity</notes>
    </interface>
    <interface name="createPasswordResetToken" kind="function">
      <signature>(userId: string) => Promise&lt;string&gt;</signature>
      <path>src/lib/auth/service.ts</path>
      <notes>Generate crypto.randomBytes(32).toString('hex'), hash and store</notes>
    </interface>
    <interface name="findPasswordResetToken" kind="function">
      <signature>(tokenHash: string) => Promise&lt;PasswordResetToken | null&gt;</signature>
      <path>src/lib/auth/service.ts</path>
      <notes>Lookup by hash, check not expired, not used</notes>
    </interface>
    <interface name="updateUserPassword" kind="function">
      <signature>(userId: string, newPasswordHash: string) => Promise&lt;void&gt;</signature>
      <path>src/lib/auth/service.ts</path>
      <notes>Update user's passwordHash in database</notes>
    </interface>
    <interface name="sendPasswordResetEmail" kind="function">
      <signature>(email: string, token: string) => Promise&lt;void&gt;</signature>
      <path>src/lib/email/email-service.ts</path>
      <notes>ALREADY IMPLEMENTED - sends reset email via Resend</notes>
    </interface>
  </interfaces>

  <constraints>
    <constraint type="security">Token must be cryptographically secure - use crypto.randomBytes(32), NOT JWT</constraint>
    <constraint type="security">Store token HASH in database, not raw token (prevent DB leak exposure)</constraint>
    <constraint type="security">No email enumeration - same response for existing and non-existing emails</constraint>
    <constraint type="security">1 hour token expiry (AUTH_CONSTANTS.PASSWORD_RESET_TOKEN_EXPIRY)</constraint>
    <constraint type="security">Single-use tokens - mark usedAt immediately after password update</constraint>
    <constraint type="security">Invalidate ALL refresh tokens on successful password reset</constraint>
    <constraint type="pattern">Follow existing auth form patterns in login-form.tsx (react-hook-form, zod, loading states)</constraint>
    <constraint type="pattern">Use toast notifications (sonner) for success/error feedback</constraint>
    <constraint type="pattern">Reuse PasswordStrengthMeter from registration for reset form</constraint>
    <constraint type="pattern">Follow API error response format: { error: string, code: string }</constraint>
    <constraint type="testing">Unit tests for token generation, hashing, lookup, expiry</constraint>
    <constraint type="testing">E2E tests for full forgot/reset flow</constraint>
  </constraints>

  <tests>
    <standards>
      Vitest for unit tests, Playwright for E2E. Follow existing patterns in tests/unit/auth/ and tests/e2e/.
      Unit tests focus on service functions and validation. E2E tests cover full user flows.
      Use descriptive test names following "it should..." pattern.
    </standards>
    <locations>
      <location>tests/unit/auth/password-reset.test.ts</location>
      <location>tests/e2e/password-reset.spec.ts</location>
    </locations>
    <ideas>
      <idea ac="AC-2.5.1">E2E: Verify forgot password link visible on login page, opens email form</idea>
      <idea ac="AC-2.5.2">Unit: Same response returned for existing and non-existing emails</idea>
      <idea ac="AC-2.5.2">E2E: Submit form shows same message regardless of email</idea>
      <idea ac="AC-2.5.3">Unit: Token with expired timestamp rejected</idea>
      <idea ac="AC-2.5.3">Unit: Token expiry is 1 hour (3600 seconds)</idea>
      <idea ac="AC-2.5.4">E2E: Reset page loads with valid token, shows password form</idea>
      <idea ac="AC-2.5.4">E2E: Reset page shows error for invalid/expired token</idea>
      <idea ac="AC-2.5.4">E2E: Password complexity validation on reset form</idea>
      <idea ac="AC-2.5.5">Unit: All refresh tokens deleted after password reset</idea>
      <idea ac="AC-2.5.5">E2E: Cannot use old session after password reset</idea>
      <idea ac="AC-2.5.6">E2E: Successful reset redirects to login with toast</idea>
      <idea ac="general">Unit: Token is cryptographically random (32 bytes = 64 hex chars)</idea>
      <idea ac="general">Unit: Token hash is stored, not raw token</idea>
      <idea ac="general">Unit: Used tokens are rejected</idea>
    </ideas>
  </tests>
</story-context>
