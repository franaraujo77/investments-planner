# Epic 6: Data Pipeline - Retrospective

**Date:** 2025-12-11
**Facilitator:** Bob (SM Agent)
**Epic:** Data Pipeline
**Stories Completed:** 9 of 9 (100%)
**Previous Epic:** Epic 5 - Scoring Engine

---

## Executive Summary

Epic 6 delivered the complete Data Pipeline - external data provider integration with freshness visibility and audit trail support. The epic achieved 100% story completion with all 9 stories passing code review. Test coverage grew exceptionally from 1436 to 1957 tests (+521, 36% growth).

**Key Achievements:**

- Provider abstraction layer with primary → fallback → stale cache chain
- Gemini API for fundamentals, Yahoo Finance fallback for prices
- ExchangeRate-API and Open Exchange Rates for currency conversion
- Rate-limited force refresh (5 per hour per user)
- Data freshness display with color-coded badges
- Source attribution for all data points
- Calculation breakdown with JSON export and deterministic replay

**Critical Finding:** Console.error technical debt from Epic 3-4-5 persists with 42 occurrences across 31 files. Pre-commit hook exists but ESLint rule is "warn" not "error". Bmad has declared this a **HARD BLOCKER** for Epic 7.

---

## Story Completion Summary

| Story | Title                        | Status | Review   | Tests Added |
| ----- | ---------------------------- | ------ | -------- | ----------- |
| 6.1   | Provider Abstraction Layer   | done   | APPROVED | ~30         |
| 6.2   | Fetch Asset Fundamentals     | done   | APPROVED | ~25         |
| 6.3   | Fetch Daily Prices           | done   | APPROVED | ~35         |
| 6.4   | Fetch Exchange Rates         | done   | APPROVED | ~30         |
| 6.5   | Currency Conversion Logic    | done   | APPROVED | ~58         |
| 6.6   | Force Data Refresh           | done   | APPROVED | ~62         |
| 6.7   | Data Freshness Display       | done   | APPROVED | ~67         |
| 6.8   | Data Source Attribution      | done   | APPROVED | ~57         |
| 6.9   | Calculation Breakdown Access | done   | APPROVED | ~38         |

**Total Tests:** 1957 (up from 1436 at Epic 5 end = +521 tests, 36% growth)

---

## What Went Well

### 1. Provider Abstraction Pattern Excellence

- Clean ADR-005 implementation: primary → fallback → stale cache
- Circuit breaker pattern for failing providers
- Retry logic with exponential backoff (3 attempts)
- Factory functions for dependency injection
- All providers populate `source` field for attribution

### 2. Exceptional Test Coverage

- 521 new tests added across the epic (~58 per story average)
- Test count growth: 1436 → 1957 (36% increase)
- Comprehensive unit tests for each provider
- API integration tests for all endpoints
- Rate limiting tests with time mocking
- Determinism verification tests for replay

### 3. Event Sourcing Extension

- Added CURRENCY_CONVERTED event type for audit trail
- Added DATA_REFRESHED event type for refresh tracking
- Calculation replay with determinism verification
- All events linked via correlation_id

### 4. Strong TypeScript Discipline

- All 9 stories handled `exactOptionalPropertyTypes` correctly
- Zod v4 compatibility maintained (`z.record()` with 2 arguments)
- decimal.js precision maintained throughout currency conversion
- Proper handling of optional properties with spread patterns

### 5. Documentation Quality

- Dev Agent Records well-documented in each story
- "Learnings from Previous Story" sections enabled pattern reuse
- Completion notes captured key decisions
- File lists documented all changes

---

## What Could Be Improved

### 1. Console.error Technical Debt (RECURRING - 4 EPICS)

**Severity:** CRITICAL BLOCKER

- Pattern first identified in Epic 3
- Partially addressed in Epic 4 (ESLint rule added as "warn")
- Committed as CRITICAL blocker in Epic 5 retrospective
- Still present: **42 occurrences across 31 files**
- Root cause: ESLint rule is "warn" not "error" - doesn't block commits

**Files with console.error (31 total):**

- `src/app/(dashboard)/portfolio/portfolio-page-client.tsx` (2)
- `src/lib/services/account-service.ts` (2)
- `src/lib/telemetry/logger.ts` (2)
- `src/app/api/investments/route.ts` (2)
- And 27 more files...

### 2. Epic 5 Action Items Incomplete

| Action Item                         | Committed | Status        |
| ----------------------------------- | --------- | ------------- |
| Console.error cleanup (20+ files)   | CRITICAL  | NOT COMPLETED |
| Add pre-commit hook                 | CRITICAL  | Completed     |
| Update CLAUDE.md Definition of Done | CRITICAL  | Partial       |
| Verify Vercel KV cache              | CRITICAL  | Completed     |
| Upgrade no-console to "error"       | PROCESS   | NOT COMPLETED |
| Use standardized error helpers      | PROCESS   | Completed     |

**Follow-Through Rate:** 3/6 (50%) - down from Epic 5's 100%

### 3. Test Mock Hygiene

- Story 6.9 had test mock mismatch requiring revision cycle
- Mock used `ERROR_CODES` but actual exports `VALIDATION_ERRORS`, `NOT_FOUND_ERRORS`, `INTERNAL_ERRORS`
- Caught in code review but caused delay

### 4. Deferred UI Integrations

- DataFreshnessBadge component ready but not integrated into pages
- SourceAttribution components ready but dashboard/portfolio are placeholders
- Integration debt accumulating until Epic 7

### 5. Task Checkbox Hygiene

- Story 6.8 task checkboxes remained unchecked despite completion
- Documentation artifact only but affects clarity

---

## Key Learnings

### Technical Learnings

| Learning                             | Context                      | Impact                     |
| ------------------------------------ | ---------------------------- | -------------------------- |
| Provider fallback chain is resilient | Primary → fallback → cache   | Users always see data      |
| Rate limiting needs server + client  | Token bucket + countdown UI  | Good UX when limited       |
| decimal.js essential for currency    | All conversion calculations  | No floating point errors   |
| Event types need type guards         | `isDataRefreshedEvent()`     | Type-safe event handling   |
| Zod v4 has breaking changes          | `z.record()` requires 2 args | Watch for migration issues |

### Process Learnings

1. **"Warn" rules don't prevent** - ESLint warnings are ignored; only errors block
2. **Pre-commit hooks need teeth** - Hook exists but rule is ineffective
3. **Technical debt compounds** - 4 epics of console.error = 42 occurrences
4. **Test mocks must match reality** - Mock/implementation mismatch causes review cycles
5. **Deferred work accumulates** - UI integration debt needs explicit tracking

---

## Action Items

### HARD BLOCKERS (Before Epic 7 can start)

| #   | Action Item                              | Owner | Success Criteria                        | Deadline      |
| --- | ---------------------------------------- | ----- | --------------------------------------- | ------------- |
| 1   | **Complete console.error cleanup**       | Dev   | 0 console.\* in src/ (except logger.ts) | Before Epic 7 |
| 2   | **Upgrade ESLint no-console to "error"** | Dev   | Build fails on violations               | Before Epic 7 |

### MUST DO (During Epic 7)

| #   | Action Item                                         | Owner | Success Criteria                 |
| --- | --------------------------------------------------- | ----- | -------------------------------- |
| 3   | Integrate DataFreshnessBadge into dashboard         | Dev   | Badge visible on all data points |
| 4   | Integrate SourceAttribution into portfolio/scores   | Dev   | Source visible on hover/detail   |
| 5   | Replace hardcoded USD/BRL with user's base currency | Dev   | TODO(epic-8) resolved            |

### PROCESS IMPROVEMENTS

| #   | Action Item                                       | Owner | Success Criteria                   |
| --- | ------------------------------------------------- | ----- | ---------------------------------- |
| 6   | Add test mock validation to code review checklist | SM    | Checklist updated                  |
| 7   | Track deferred items in sprint-status.yaml        | SM    | Deferred column added              |
| 8   | Verify task checkboxes before story-done          | Dev   | No unchecked boxes on done stories |

---

## Team Agreements

1. **ESLint errors are non-negotiable** - "warn" rules will be upgraded to "error" once violations are fixed
2. **Console.\* banned except in logger.ts** - All logging through structured logger
3. **Test mocks must mirror actual exports** - Verify mock structure matches implementation
4. **Deferred items must be tracked** - Add to backlog or TODO(epic-N) markers

---

## Epic 5 → Epic 6 Patterns

### What Improved

- Test coverage growth remained strong (52% → 36%)
- Event sourcing pattern continued well
- Provider abstraction delivered as planned

### What Regressed

- Action item follow-through: 100% → 50%
- Technical debt continued accumulating
- Prevention mechanisms not fully implemented

---

## Metrics Summary

| Metric                   | Value      |
| ------------------------ | ---------- |
| Stories Completed        | 9/9 (100%) |
| Tests Added              | +521       |
| Total Tests Passing      | 1957       |
| Test Growth (vs Epic 5)  | +36%       |
| Lint Errors              | 0          |
| Build Status             | Passing    |
| Review Outcomes          | 9 APPROVED |
| Hard Blockers for Epic 7 | 2          |
| Action Items Total       | 8          |

---

## Next Epic Preview

**Epic 7: Recommendations** (11 stories planned, status: backlog)

**Goal:** Deliver the core product value - simple, actionable investment recommendations.

**User Value:** Users can answer "What should I buy this month?" in under 5 minutes.

**FRs Covered:** FR44-FR55

**Key Stories:**

- 7.1: Enter Monthly Contribution
- 7.2: Enter Dividends Received
- 7.3: Calculate Total Investable Capital
- 7.4: Generate Investment Recommendations
- 7.5: Display Recommendations (Focus Mode)
- 7.6: Zero Buy Signal for Over-Allocated
- 7.7: View Recommendation Breakdown
- 7.8-7.11: Confirmation and history flows

**Dependencies on Epic 6:**

- Provider abstraction for real-time data
- Currency conversion for multi-currency portfolios
- Score calculation engine from Epic 5
- Data freshness for trust indicators

**Integration Work (from Epic 6 deferred):**

- DataFreshnessBadge on recommendation cards
- SourceAttribution in recommendation breakdown

**BLOCKERS:**

- Console.error cleanup MUST complete before Epic 7 kickoff
- ESLint no-console MUST be "error" before Epic 7

---

## Readiness Assessment

| Area                | Status                  |
| ------------------- | ----------------------- |
| Testing & Quality   | All 1957 tests passing  |
| TypeScript          | Compiles clean          |
| ESLint              | No errors (42 warnings) |
| Build               | Successful              |
| Technical Health    | Stable with known debt  |
| Blockers for Epic 7 | 2 HARD BLOCKERS         |

---

## Team Participants

- Alice (Product Owner) - Business context and provider pattern value
- Bob (Scrum Master) - Facilitated retrospective
- Charlie (Senior Dev) - Technical insights on test mocking and debt
- Dana (QA) - Test coverage observations
- Elena (Junior Dev) - Documentation quality feedback
- Bmad (Project Lead) - Decision on blockers and integration timing

---

## Bmad Decisions

1. **Console.error cleanup:** HARD BLOCKER for Epic 7 - must complete before starting
2. **ESLint upgrade:** Immediate - upgrade no-console from "warn" to "error"
3. **Deferred integrations:** Integrate DataFreshnessBadge and SourceAttribution during Epic 7

---

## Change Log

| Date       | Author              | Change                                       |
| ---------- | ------------------- | -------------------------------------------- |
| 2025-12-11 | SM Agent (Bob)      | Retrospective document created               |
| 2025-12-11 | Bmad (Project Lead) | Confirmed blockers and integration decisions |
