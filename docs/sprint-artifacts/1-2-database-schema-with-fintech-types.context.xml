<story-context id="bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>2</storyId>
    <title>Database Schema with Fintech Types</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-30</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-2-database-schema-with-fintech-types.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>PostgreSQL database with Drizzle ORM and fintech-appropriate types</iWant>
    <soThat>financial calculations are accurate and type-safe</soThat>
    <tasks>
      <task id="1" ac="1">Install Drizzle ORM and dependencies (drizzle-orm, postgres, drizzle-kit, decimal.js, zod)</task>
      <task id="2" ac="1">Configure database connection with Drizzle client, drizzle.config.ts, and scripts</task>
      <task id="3" ac="1,2,4,5">Create users table schema with uuid, varchar, timestamp fields</task>
      <task id="4" ac="1,4,5">Create refresh_tokens table schema with FK to users, CASCADE delete</task>
      <task id="5" ac="1,4,5">Create calculation_events table for event sourcing with jsonb payload</task>
      <task id="6" ac="3">Configure decimal.js with precision: 20, rounding: ROUND_HALF_UP</task>
      <task id="7" ac="4">Create event types (CALC_STARTED, INPUTS_CAPTURED, SCORES_COMPUTED, CALC_COMPLETED)</task>
      <task id="8" ac="1">Run initial migration with db:generate and db:migrate</task>
      <task id="9" ac="3">Test decimal.js configuration (0.1 + 0.2 = 0.3)</task>
      <task id="10" ac="1,2,4,5">Test database schema (migrations, column types, FK constraints, indexes)</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Running `pnpm db:migrate` creates all tables with correct types</criterion>
    <criterion id="2">All currency/monetary fields use `numeric(19,4)` type (NEVER float/double)</criterion>
    <criterion id="3">decimal.js is configured with precision: 20, rounding: ROUND_HALF_UP</criterion>
    <criterion id="4">Drizzle schema includes: users, refresh_tokens, calculation_events tables</criterion>
    <criterion id="5">Multi-tenant isolation is enforced via user_id foreign keys</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Story 1.2: Database Schema with Fintech Types</section>
        <snippet>Drizzle schema includes: users, portfolios, assets, asset_classes, criteria, scores tables. All currency/monetary fields use numeric(19,4) type. decimal.js configured with precision: 20, rounding: ROUND_HALF_UP.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Data Models and Contracts</section>
        <snippet>Complete schema definitions for users, refresh_tokens, calculation_events tables with PostgreSQL types, indexes, and foreign key relationships.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>ADR-002: Event-Sourced Calculations</section>
        <snippet>Store calculation events, not just results. 4 event types: CALC_STARTED, INPUTS_CAPTURED, SCORES_COMPUTED, CALC_COMPLETED. Events are immutable and append-only.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Critical Risk Mitigations</section>
        <snippet>Use decimal.js library; PostgreSQL numeric type for all currency fields. Decimal.set({ precision: 20, rounding: Decimal.ROUND_HALF_UP }). Drizzle schema: numeric('value', { precision: 19, scale: 4 }).</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 1.2: Database Schema with Fintech Types</section>
        <snippet>PostgreSQL numeric type for ALL monetary values. Configure decimal.js with precision: 20, rounding: ROUND_HALF_UP. Create lib/calculations/decimal-utils.ts for financial math helpers.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Domain-Specific Requirements (Fintech)</section>
        <snippet>Financial Data Accuracy is CRITICAL - investment decisions depend on correct calculations, errors have real consequences. Multi-currency portfolios calculated accurately to the cent.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>src/lib/utils.ts</path>
        <kind>utility</kind>
        <symbol>cn</symbol>
        <lines>1-6</lines>
        <reason>Existing lib folder pattern - new db and calculations modules should follow same structure</reason>
      </file>
      <file>
        <path>src/hooks/use-mobile.ts</path>
        <kind>hook</kind>
        <symbol>useMobile</symbol>
        <reason>Existing hooks folder pattern - may need to create hooks for database state if needed</reason>
      </file>
      <file>
        <path>tsconfig.json</path>
        <kind>config</kind>
        <symbol>compilerOptions</symbol>
        <lines>7-9</lines>
        <reason>TypeScript strict mode with noUncheckedIndexedAccess and exactOptionalPropertyTypes - Drizzle types must satisfy these</reason>
      </file>
      <file>
        <path>.env.example</path>
        <kind>config</kind>
        <symbol>DATABASE_URL</symbol>
        <lines>14-18</lines>
        <reason>DATABASE_URL placeholder already exists - connection string format documented</reason>
      </file>
      <file>
        <path>docs/sprint-artifacts/1-1-project-setup-core-infrastructure.md</path>
        <kind>reference</kind>
        <symbol>previous-story</symbol>
        <reason>Previous story completion notes - Next.js 16.0.5 installed, TypeScript strict mode enabled, path aliases configured</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <existing>
          <package version="16.0.5">next</package>
          <package version="19.2.0">react</package>
          <package version="^4.1.13">zod</package>
          <package version="^5">typescript</package>
        </existing>
        <required>
          <package>drizzle-orm</package>
          <package>postgres</package>
          <package>decimal.js</package>
        </required>
        <requiredDev>
          <package>drizzle-kit</package>
        </requiredDev>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="architecture">NEVER use float or double precision for monetary values - use PostgreSQL numeric(19,4) exclusively</constraint>
    <constraint source="architecture">decimal.js must be configured with precision: 20, rounding: ROUND_HALF_UP before any calculations</constraint>
    <constraint source="architecture">All user data must be isolated via user_id foreign keys for multi-tenant security</constraint>
    <constraint source="architecture">Event sourcing: store immutable, append-only events with correlation_id for audit trail</constraint>
    <constraint source="typescript">TypeScript strict mode with noUncheckedIndexedAccess - handle undefined in array/object access</constraint>
    <constraint source="typescript">exactOptionalPropertyTypes enabled - be explicit about undefined vs optional</constraint>
    <constraint source="conventions">Use @/ path alias for imports (e.g., @/lib/db)</constraint>
    <constraint source="conventions">Follow existing src/lib/* folder pattern for new modules</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Users Table Schema</name>
      <kind>drizzle-table</kind>
      <signature>
pgTable('users', {
  id: uuid('id').primaryKey().defaultRandom(),
  email: varchar('email', { length: 255 }).notNull().unique(),
  passwordHash: varchar('password_hash', { length: 255 }).notNull(),
  name: varchar('name', { length: 100 }),
  baseCurrency: varchar('base_currency', { length: 3 }).notNull().default('USD'),
  emailVerified: boolean('email_verified').default(false),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow()
})
      </signature>
      <path>src/lib/db/schema.ts</path>
    </interface>
    <interface>
      <name>Refresh Tokens Table Schema</name>
      <kind>drizzle-table</kind>
      <signature>
pgTable('refresh_tokens', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  tokenHash: varchar('token_hash', { length: 255 }).notNull(),
  deviceFingerprint: varchar('device_fingerprint', { length: 255 }),
  expiresAt: timestamp('expires_at').notNull(),
  createdAt: timestamp('created_at').defaultNow()
})
      </signature>
      <path>src/lib/db/schema.ts</path>
    </interface>
    <interface>
      <name>Calculation Events Table Schema</name>
      <kind>drizzle-table</kind>
      <signature>
pgTable('calculation_events', {
  id: uuid('id').primaryKey().defaultRandom(),
  correlationId: uuid('correlation_id').notNull(),
  userId: uuid('user_id').notNull().references(() => users.id),
  eventType: varchar('event_type', { length: 50 }).notNull(),
  payload: jsonb('payload').notNull(),
  createdAt: timestamp('created_at').defaultNow()
})
      </signature>
      <path>src/lib/db/schema.ts</path>
    </interface>
    <interface>
      <name>CalculationEvent Type</name>
      <kind>typescript-type</kind>
      <signature>
type CalculationEvent =
  | { type: 'CALC_STARTED'; correlationId: string; userId: string; timestamp: Date; market?: string }
  | { type: 'INPUTS_CAPTURED'; correlationId: string; criteriaVersionId: string; criteria: CriteriaConfig; prices: PriceSnapshot[]; rates: ExchangeRateSnapshot[]; assetIds: string[] }
  | { type: 'SCORES_COMPUTED'; correlationId: string; results: Array&lt;{ assetId: string; score: string; breakdown: CriterionScore[] }&gt; }
  | { type: 'CALC_COMPLETED'; correlationId: string; duration: number; assetCount: number; status: 'success' | 'partial' | 'failed' }
      </signature>
      <path>src/lib/events/types.ts</path>
    </interface>
    <interface>
      <name>Decimal Configuration</name>
      <kind>configuration</kind>
      <signature>
Decimal.set({
  precision: 20,
  rounding: Decimal.ROUND_HALF_UP,
  toExpNeg: -9,
  toExpPos: 20
})
      </signature>
      <path>src/lib/calculations/decimal-config.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing framework deferred to Story 1.7 (Vitest + Playwright Testing Setup). For this story, create test files in preparation. Use Vitest for unit tests in tests/unit/ directory. Focus tests on decimal.js precision calculations and schema type safety. All tests should run with `pnpm test` once framework is set up.
    </standards>
    <locations>
      <location>tests/unit/calculations/</location>
      <location>tests/unit/db/</location>
    </locations>
    <ideas>
      <idea ac="3">Test 0.1 + 0.2 equals exactly 0.3 (not 0.30000000000000004) using decimal.js</idea>
      <idea ac="3">Test ROUND_HALF_UP behavior: 2.5 rounds to 3, 3.5 rounds to 4</idea>
      <idea ac="3">Test precision handles 19-digit numbers without loss: 1234567890123456789.1234</idea>
      <idea ac="2">Test currency formatting outputs correct decimal places</idea>
      <idea ac="1,4">Test migration creates all 3 tables (users, refresh_tokens, calculation_events)</idea>
      <idea ac="5">Test cascade delete: deleting user removes associated refresh_tokens</idea>
      <idea ac="4">Test indexes exist on correlation_id and user_id in calculation_events</idea>
      <idea ac="1">Test TypeScript types compile without errors with strict mode</idea>
    </ideas>
  </tests>
</story-context>
