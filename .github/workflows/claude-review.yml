name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '.github/workflows/**'

jobs:
  review:
    name: Claude Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are reviewing PR #${{ github.event.pull_request.number }} in ${{ github.repository }}.

            Please review this pull request thoroughly, focusing on:
            1. Code quality and best practices
            2. Potential bugs or logic errors
            3. Security vulnerabilities (SQL injection, XSS, etc.)
            4. Performance considerations
            5. TypeScript type safety

            The PR branch is already checked out. Use the available tools to:
            - Read the diff with `gh pr diff`
            - View PR details with `gh pr view`
            - Add inline comments for specific issues using `mcp__github_inline_comment__create_inline_comment`
            - Submit your final review with `gh pr review` using --approve, --comment, or --request-changes

            After your review:
            - If the code is good with no major issues: approve with `gh pr review --approve -b "Your summary"`
            - If there are minor issues but acceptable: comment with `gh pr review --comment -b "Your summary"`
            - If there are significant issues that must be fixed: request changes with `gh pr review --request-changes -b "Your summary"`

            Be thorough but pragmatic. Focus on real issues, not style preferences.

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr review:*),Read,Glob,Grep"
